<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expert Prompt Crafter - Neutral Theme (Debug)</title>
    <style>
        /* Neutral Theme Color Palette Variables */
        :root {
            --app-primary-dark: #004225;    /* Darker, rich green */
            --app-primary-medium: #006A3E;  /* A slightly lighter green for accents/buttons */
            --app-accent-gold: #B8860B;     /* Gold/dark yellow for accents */
            --app-gray-light: #f0f2f5;      /* Very light gray for main background */
            --app-gray-medium: #cccccc;     /* Medium gray for borders, secondary elements */
            --app-gray-dark: #4A4A4A;       /* Dark gray for text */
            --app-gray-sidebar: #e9ecef;    /* Sidebar background */
            --app-white: #ffffff;
            --app-text-on-dark: #ffffff;
            --app-text-on-light: #333333;
            --app-focus-ring: rgba(0, 106, 62, 0.3); /* Focus ring for primary elements */
        }

        /* General body styling */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--app-gray-light);
            color: var(--app-text-on-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Main container for the app layout */
        .container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
        }

        /* Header styling */
        header {
            background-color: var(--app-primary-dark);
            color: var(--app-text-on-dark);
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.75em;
        }

        /* Styling for the reset button */
        .reset-button {
            background-color: var(--app-accent-gold);
            color: var(--app-text-on-dark);
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .reset-button:hover {
            background-color: #A5760A; /* Darker gold */
        }

        /* Main content area where steps are displayed */
        .main-content {
            flex: 3;
            background-color: var(--app-white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Sidebar for the live prompt preview */
        .sidebar {
            flex: 2;
            background-color: var(--app-gray-sidebar);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .sidebar h3 {
            margin-top: 0;
            color: var(--app-primary-dark);
            font-size: 1.25em;
            border-bottom: 2px solid var(--app-gray-medium);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Styling for each step in the wizard */
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--app-gray-medium);
            border-radius: 6px;
            background-color: var(--app-white);
            transition: border-left 0.3s ease;
        }

        .step.active {
            border-left: 5px solid var(--app-primary-medium);
            background-color: var(--app-white);
        }

        .step h2 {
            font-size: 1.5em;
            color: var(--app-primary-dark);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .step h4 { /* Used for sub-headings within steps */
            font-size: 1.1em;
            color: var(--app-gray-dark);
            margin-top: 20px; /* Space above sub-heading */
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        .step p.instructional-text {
            font-size: 0.95em;
            color: var(--app-gray-dark);
            margin-bottom: 15px;
        }
         .step p.small-note {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: -10px;
            margin-bottom: 15px;
        }


        /* Input fields and textareas */
        .input-field, .large-input-field, .number-input-field, .url-input-field {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 5px;
            border: 1px solid var(--app-gray-medium);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus, .large-input-field:focus, .number-input-field:focus, .url-input-field:focus {
            border-color: var(--app-primary-medium);
            box-shadow: 0 0 0 3px var(--app-focus-ring);
            outline: none;
        }

        .large-input-field {
            min-height: 100px;
            resize: vertical;
        }
         .number-input-field {
            width: 150px;
        }
         .url-input-field {
            /* Full width by default */
        }


        .sub-element-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px dashed var(--app-gray-medium);
            border-radius: 4px;
        }


        .checkbox-group {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 0.95em;
            color: var(--app-text-on-light);
            cursor: pointer;
            padding: 5px 0;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--app-primary-medium);
        }


        /* Tooltip icon and text styling */
        .tooltip-container {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .tooltip-container label {
            font-weight: 500;
            color: var(--app-text-on-light);
            font-size: 0.95em;
            margin-right: 5px;
        }
        .sub-element-container .tooltip-container label {
             font-weight: normal;
             font-size: 0.9em;
        }


        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--app-gray-dark);
            color: var(--app-text-on-dark);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            font-weight: bold;
            cursor: help;
            font-size: 0.75em;
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--app-gray-dark);
            color: var(--app-text-on-dark);
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 10;
            bottom: 135%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 0.85em;
            line-height: 1.5;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .tooltip-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Navigation buttons (Back, Next) */
        .nav-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
        }

        .nav-buttons button {
            background-color: var(--app-primary-medium);
            color: var(--app-text-on-dark);
            border: none;
            padding: 12px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .nav-buttons button.back-button {
            background-color: var(--app-gray-medium);
            color: var(--app-text-on-light);
        }
        .nav-buttons button.back-button:hover {
            background-color: #b3b3b3;
        }


        .nav-buttons button:hover {
            opacity: 0.9;
        }
        .nav-buttons button:active {
            transform: translateY(1px);
        }

        .nav-buttons button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Live prompt preview area styling */
        #live-prompt-preview-area {
            flex-grow: 1;
            background-color: #f8f9fa;
            border: 1px solid var(--app-gray-medium);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            margin-bottom: 15px;
            min-height: 200px;
            font-size: 0.9em;
            color: var(--app-text-on-light);
            line-height: 1.6;
        }

        /* Sidebar buttons */
        .sidebar-button {
            background-color: var(--app-primary-medium);
            color: var(--app-text-on-dark);
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.05em;
            width: 100%;
            transition: background-color 0.3s ease;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .sidebar-button:hover {
            background-color: var(--app-primary-dark);
        }
        .sidebar-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }


        /* Feedback message for copy action */
        #copy-feedback {
            text-align:center;
            color: var(--app-primary-medium);
            font-weight:bold;
            height: 20px;
            margin-top: 8px;
            font-size: 0.9em;
        }

        /* Radio button group styling */
        .radio-group label {
            display: block;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            border: 1px solid var(--app-gray-medium);
            background-color: var(--app-white);
        }
        .radio-group label:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .radio-group input[type="radio"] {
            margin-right: 10px;
            transform: translateY(1px);
            accent-color: var(--app-primary-medium);
        }
        .radio-group input[type="radio"]:checked + span {
            font-weight: 600;
            color: var(--app-primary-dark);
        }
         .radio-group label.selected {
            background-color: #e6f0eC; /* Very light version of primary color */
            border-color: var(--app-primary-medium);
        }


        .hidden {
            display: none;
        }

        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            header h1 {
                font-size: 1.5em;
            }
            .reset-button {
                padding: 8px 15px;
            }
        }
        @media (max-width: 576px) {
             header {
                padding: 12px 15px;
            }
            header h1 {
                font-size: 1.3em;
            }
            .main-content, .sidebar {
                padding: 15px;
            }
            .step {
                padding: 15px;
            }
            .nav-buttons button {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .input-field, .large-input-field, .number-input-field, .url-input-field {
                padding: 10px;
            }
            #live-prompt-preview-area {
                min-height: 150px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1>Expert Prompt Crafter</h1>
        <button id="reset-app-button" class="reset-button">Reset</button>
    </header>

    <div class="container">
        <div class="main-content">
            <div id="step-1" class="step active">
                <h2>Step 1: Define Your Task</h2>
                <p class="instructional-text">Clearly state what you want the AI to do. Be specific! Ensure your input here is well-phrased and free of typos for the best results.</p>
                <div class="tooltip-container">
                  <label for="task-definition">Your Core Task:</label>
                  <span class="tooltip-icon">i
                      <span class="tooltip-text">Examples: 'Summarize the provided text,' 'Generate 5 creative taglines for a new coffee shop,' 'Translate this sentence into Spanish,' 'Write a Python function to sort a list.'</span>
                  </span>
                </div>
                <textarea id="task-definition" class="large-input-field" placeholder="e.g., Write a three-paragraph blog post about the benefits of meditation for stress relief."></textarea>
                <div class="nav-buttons">
                    <span></span> <button class="next-button" onclick="goToStep(2)">Next &rarr;</button>
                </div>
            </div>

            <div id="step-2" class="step hidden">
                <h2>Step 2: Set the AI's Persona (Optional)</h2>
                <p class="instructional-text">Instructing the AI to 'act as' someone specific helps it adopt the right tone, style, and knowledge.</p>
                <div class="tooltip-container">
                    <label for="ai-persona">AI Persona:</label>
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">Examples: 'a seasoned historian,' 'a Python programming expert,' 'a travel guide for adventurous backpackers,' 'a children's storyteller.'</span>
                    </span>
                </div>
                <input type="text" id="ai-persona" class="input-field" placeholder="e.g., an expert copywriter, a friendly teacher">
                <div class="nav-buttons">
                    <button class="back-button" onclick="goToStep(1)">&larr; Back</button>
                    <button class="next-button" onclick="goToStep(3)">Next &rarr;</button>
                </div>
            </div>

            <div id="step-3" class="step hidden">
                <h2>Step 3: Provide Essential Context</h2>
                <p class="instructional-text">Paste any background information, data, specific points to include, or text the AI needs to work with. Clear, concise context is crucial.</p>
                <div class="tooltip-container">
                    <label for="key-context">Background Information / Data:</label>
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">If summarizing, paste the text here. If writing about a product, provide its features and benefits. The more relevant context, the better the output.</span>
                    </span>
                </div>
                <textarea id="key-context" class="large-input-field" placeholder="e.g., Product details, specific arguments to make, text to be summarized..."></textarea>
                <div class="nav-buttons">
                    <button class="back-button" onclick="goToStep(2)">&larr; Back</button>
                    <button class="next-button" onclick="goToStep(4)">Next &rarr;</button>
                </div>
            </div>

            <div id="step-4" class="step hidden">
                <h2>Step 4: Choose the Output Format</h2>
                <p class="instructional-text">How should the AI present its response? This helps structure the output.</p>
                
                <h4>Output Type:</h4>
                <div class="radio-group" id="output-format">
                    <label><input type="radio" name="outputFormat" value="Paragraph(s)" checked> <span>Paragraph(s)</span></label>
                    <label><input type="radio" name="outputFormat" value="Bulleted List"> <span>Bulleted List</span></label>
                    <label><input type="radio" name="outputFormat" value="Numbered List"> <span>Numbered List</span></label>
                    <label><input type="radio" name="outputFormat" value="Email"> <span>Email</span></label>
                    <label><input type="radio" name="outputFormat" value="Code Snippet"> <span>Code Snippet</span></label>
                    <label><input type="radio" name="outputFormat" value="Table"> <span>Table</span></label>
                    <label><input type="radio" name="outputFormat" value="Short Answer"> <span>Short Answer</span></label>
                    <label><input type="radio" name="outputFormat" value="JSON Object"> <span>JSON Object</span></label>
                    <label><input type="radio" name="outputFormat" value="Markdown Text"> <span>Markdown Text</span></label>
                    <label><input type="radio" name="outputFormat" value="Lengthy Comprehensive Report"> <span>Lengthy Comprehensive Report</span></label>
                </div>
                
                <div id="word-count-container" class="sub-element-container hidden">
                    <div class="tooltip-container">
                        <label for="word-count">Target Word Count (approx.):</label>
                        <span class="tooltip-icon">i
                            <span class="tooltip-text">Specify an approximate number of words for the output. Leave blank if not critical.</span>
                        </span>
                    </div>
                    <input type="number" id="word-count" class="number-input-field" placeholder="e.g., 500">
                </div>

                <h4 style="margin-top: 20px;">Detail Level:</h4>
                <div class="radio-group" id="detail-level-selection">
                    <label><input type="radio" name="detailLevel" value="Brief Overview"> <span>Brief Overview</span></label>
                    <label><input type="radio" name="detailLevel" value="Standard Detail" checked> <span>Standard Detail</span></label>
                    <label><input type="radio" name="detailLevel" value="Comprehensive Explanation"> <span>Comprehensive Explanation</span></label>
                </div>
                <div class="tooltip-container" style="margin-top:5px;">
                     <span class="tooltip-icon">i
                        <span class="tooltip-text">'Brief': High-level summary. 'Standard': Balanced detail. 'Comprehensive': In-depth explanation with examples.</span>
                    </span>
                 </div>


                 <div class="tooltip-container" style="margin-top:20px;"> <span class="tooltip-icon">i
                        <span class="tooltip-text">Select the primary type of output you expect. Additional controls like word count or detail level help refine it further.</span>
                    </span>
                 </div>
                <div class="nav-buttons">
                    <button class="back-button" onclick="goToStep(3)">&larr; Back</button>
                    <button class="next-button" onclick="goToStep(5)">Next &rarr;</button>
                </div>
            </div>

            <div id="step-5" class="step hidden">
                <h2>Step 5: Select the Tone (Optional)</h2>
                <p class="instructional-text">What feeling or style should the AI's response convey?</p>
                <div class="radio-group" id="tone-selection">
                    <label><input type="radio" name="tone" value="Formal"> <span>Formal</span></label>
                    <label><input type="radio" name="tone" value="Informal"> <span>Informal</span></label>
                    <label><input type="radio" name="tone" value="Friendly" checked> <span>Friendly</span></label>
                    <label><input type="radio" name="tone" value="Persuasive"> <span>Persuasive</span></label>
                    <label><input type="radio" name="tone" value="Neutral"> <span>Neutral</span></label>
                    <label><input type="radio" name="tone" value="Humorous"> <span>Humorous</span></label>
                    <label><input type="radio" name="tone" value="Empathetic"> <span>Empathetic</span></label>
                    <label><input type="radio" name="tone" value="Authoritative"> <span>Authoritative</span></label>
                    <label><input type="radio" name="tone" value="Concise"> <span>Concise</span></label>
                </div>
                <div class="tooltip-container" style="margin-top:10px;">
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">A 'Formal' tone is suitable for business reports, while 'Friendly' might be better for customer service. 'Authoritative' implies expertise. 'Concise' aims for brevity.</span>
                    </span>
                </div>
                <div class="nav-buttons">
                    <button class="back-button" onclick="goToStep(4)">&larr; Back</button>
                    <button class="next-button" onclick="goToStep(6)">Next (Advanced) &rarr;</button>
                </div>
            </div>

            <div id="step-6" class="step hidden">
                <h2>Step 6: Fine-Tune Your Prompt (Advanced)</h2>
                <p class="instructional-text">Add more specific instructions to guide the AI for a more precise and robust output. Be mindful of potential typos in your inputs.</p>

                <div class="tooltip-container">
                    <label for="audience-definition">Target Audience:</label>
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">Describing the audience helps the AI tailor its language, complexity, and style. (e.g., Beginners, Technical experts, Potential customers)</span>
                    </span>
                </div>
                <input type="text" id="audience-definition" class="input-field" placeholder="e.g., Marketing professionals, High school students">

                <div class="tooltip-container" style="margin-top: 15px;">
                     <label for="mandatory-inclusions">Mandatory Inclusions (one per line):</label>
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">List any specific keywords, phrases, facts, or elements that absolutely MUST be in the response.</span>
                    </span>
                </div>
                <textarea id="mandatory-inclusions" class="large-input-field" placeholder="e.g., Mention our new 'Synergy' feature\nInclude a reference to the Q3 report"></textarea>

                <div class="tooltip-container" style="margin-top: 15px;">
                    <label for="constraints-avoid">Key Constraints or Things to AVOID (one per line):</label>
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">Specify limitations, topics to exclude, or styles to prevent. (e.g., Do not exceed 300 words\nAvoid using acronyms\nDon't mention competitor X)</span>
                    </span>
                </div>
                <textarea id="constraints-avoid" class="large-input-field" placeholder="e.g., Keep it under 5 paragraphs\nNo passive voice\nAvoid jargon"></textarea>

                <div class="tooltip-container" style="margin-top: 15px;">
                    <label for="context-url">Context URL (Optional):</label>
                    <span class="tooltip-icon">i
                        <span class="tooltip-text">Provide a URL whose content should be used as additional context. The AI will be instructed to refer to it. (Note: The app itself does not fetch the URL content.)</span>
                    </span>
                </div>
                <input type="url" id="context-url" class="url-input-field" placeholder="e.g., https://www.example.com/article">


                <div class="checkbox-group" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="encourage-step-by-step">
                        <span>Encourage Step-by-Step Thinking (Chain-of-Thought)</span>
                        <span class="tooltip-icon" style="margin-left:5px;">i
                            <span class="tooltip-text">Prompts the AI to break down its reasoning process before providing the final answer. Often leads to more thorough and accurate results for complex requests. (e.g., "Let's think step by step...")</span>
                        </span>
                    </label>
                </div>
                 <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="request-self-correction">
                        <span>Request Self-Correction / Critical Evaluation</span>
                        <span class="tooltip-icon" style="margin-left:5px;">i
                            <span class="tooltip-text">Asks the AI to review and refine its own answer for accuracy, completeness, and clarity before presenting it.</span>
                        </span>
                    </label>
                </div>


                <div class="nav-buttons">
                    <button class="back-button" onclick="goToStep(5)">&larr; Back</button>
                    <button id="generate-prompt-button-final" class="next-button" onclick="finalizePrompt()">Generate Final Prompt</button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h3>Your Generated Prompt</h3>
            <div id="live-prompt-preview-area">
                Prompt will appear here as you fill the steps...
            </div>
            <button id="generate-now-button" class="sidebar-button" disabled>Generate & Finalize Prompt Now</button>
            <button id="copy-prompt-button" class="sidebar-button" disabled>Copy to Clipboard</button>
            <p id="copy-feedback"></p> </div>
    </div>

    <script>
        // DOM element references
        const stepsElements = [
            document.getElementById('step-1'),
            document.getElementById('step-2'),
            document.getElementById('step-3'),
            document.getElementById('step-4'),
            document.getElementById('step-5'),
            document.getElementById('step-6')
        ];
        let currentStepIndex = 0;

        const taskDefinitionInput = document.getElementById('task-definition');
        const aiPersonaInput = document.getElementById('ai-persona');
        const keyContextInput = document.getElementById('key-context');
        const toneRadios = document.querySelectorAll('input[name="tone"]');
        const wordCountContainer = document.getElementById('word-count-container');
        const wordCountInput = document.getElementById('word-count');
        const contextUrlInput = document.getElementById('context-url'); 
        // const detailLevelRadios = document.querySelectorAll('input[name="detailLevel"]'); // Query for new radio group

        const audienceInput = document.getElementById('audience-definition');
        const mandatoryInclusionsInput = document.getElementById('mandatory-inclusions');
        const constraintsAvoidInput = document.getElementById('constraints-avoid');
        const encourageStepByStepCheckbox = document.getElementById('encourage-step-by-step');
        const requestSelfCorrectionCheckbox = document.getElementById('request-self-correction');

        const livePromptPreviewArea = document.getElementById('live-prompt-preview-area');
        const generateNowButton = document.getElementById('generate-now-button');
        const copyPromptButton = document.getElementById('copy-prompt-button');
        const copyFeedback = document.getElementById('copy-feedback');
        const resetButton = document.getElementById('reset-app-button');

        function cleanInput(str) {
            return str.trim();
        }

        function updateLivePreview() {
            // console.log("--- updateLivePreview called ---"); 
            let promptSegments = [];
            const taskDef = cleanInput(taskDefinitionInput.value);
            const persona = cleanInput(aiPersonaInput.value);
            const contextFromTextarea = cleanInput(keyContextInput.value);
            const outputFormatChecked = document.querySelector('input[name="outputFormat"]:checked');
            const outputFormat = outputFormatChecked ? outputFormatChecked.value : null;
            const wordCount = cleanInput(wordCountInput.value);
            const contextUrl = cleanInput(contextUrlInput.value); 
            const detailLevelChecked = document.querySelector('input[name="detailLevel"]:checked'); // Get detail level
            const detailLevel = detailLevelChecked ? detailLevelChecked.value : "Standard Detail"; // Default to standard

            // console.log("Context URL Value from input field: '", contextUrl, "'"); 

            const toneChecked = document.querySelector('input[name="tone"]:checked');
            const tone = toneChecked ? toneChecked.value : null;
            const audience = cleanInput(audienceInput.value);
            const mandatoryInclusionsRaw = cleanInput(mandatoryInclusionsInput.value);
            const constraintsAvoidRaw = cleanInput(constraintsAvoidInput.value);
            const encourageStepByStep = encourageStepByStepCheckbox.checked;
            const requestSelfCorrection = requestSelfCorrectionCheckbox.checked;
            // console.log("Encourage Step-by-Step: ", encourageStepByStep); 
            // console.log("Request Self-Correction: ", requestSelfCorrection); 


            generateNowButton.disabled = !taskDef;

            if (taskDef) {
                // console.log("Task definition exists, building prompt."); 
                let roleAndGoal = "### ROLE AND GOAL ###\n";
                if (persona) {
                    roleAndGoal += `You are to act as a ${persona}.\n`;
                }
                roleAndGoal += `Your primary objective is to: ${taskDef}.`;
                promptSegments.push(roleAndGoal);

                if (audience) {
                    promptSegments.push(`### TARGET AUDIENCE ###\nTailor your language, complexity, and style for an audience of: ${audience}.`);
                }

                let contextPartsForPromptSection = []; 
                if (contextFromTextarea) { 
                    contextPartsForPromptSection.push(`Utilize the following background information, data, or text to inform your response:\n---\n${contextFromTextarea}\n---`);
                }
                if (contextUrl) { 
                    if (contextUrl.startsWith('http://') || contextUrl.startsWith('https://')) {
                        contextPartsForPromptSection.push(`Additionally, please fetch, analyze, and incorporate the content from the following URL as crucial context for your response: ${contextUrl}\n(If you are an AI with web browsing capabilities, please access this URL. If not, acknowledge this instruction and proceed based on other provided context.)`);
                    } else {
                        contextPartsForPromptSection.push(`The user provided the following as a potential source for context (it may not be a full URL and might not be accessible by all AI models): ${contextUrl}`);
                    }
                }
                if (contextPartsForPromptSection.length > 0) {
                    promptSegments.push(`### ESSENTIAL CONTEXT & INFORMATION ###\n${contextPartsForPromptSection.join("\n\n")}`);
                }


                let inclusionsAndConstraints = "### RESPONSE REQUIREMENTS & CONSTRAINTS ###\n";
                let hasInclusionsConstraints = false;
                if (mandatoryInclusionsRaw) {
                    const inclusions = mandatoryInclusionsRaw.split('\n').map(item => cleanInput(item)).filter(item => item);
                    if (inclusions.length > 0) {
                        inclusionsAndConstraints += `Your response MUST incorporate the following elements:\n`;
                        inclusions.forEach(item => { inclusionsAndConstraints += `- ${item}\n`; });
                        hasInclusionsConstraints = true;
                    }
                }
                if (constraintsAvoidRaw) {
                    const constraints = constraintsAvoidRaw.split('\n').map(item => cleanInput(item)).filter(item => item);
                    if (constraints.length > 0) {
                        inclusionsAndConstraints += `\nStrictly observe the following CONSTRAINTS and AVOID these points:\n`;
                        constraints.forEach(item => { inclusionsAndConstraints += `- ${item}\n`; });
                        hasInclusionsConstraints = true;
                    }
                }
                if(hasInclusionsConstraints) {
                    promptSegments.push(inclusionsAndConstraints);
                }

                let outputSpecs = "### OUTPUT SPECIFICATIONS ###\n";
                if (outputFormat) {
                    outputSpecs += `Present your response in the format of a ${outputFormat}.\n`;
                    if (outputFormat === "Lengthy Comprehensive Report") {
                        outputSpecs += "This implies a detailed, multi-section document with thorough explanations, potentially including an introduction, main body sections with subheadings, supporting evidence or examples where appropriate, and a conclusion. Ensure a logical flow and clear articulation of complex points if necessary.\n";
                    }
                    if ((outputFormat === "Paragraph(s)" || outputFormat === "Lengthy Comprehensive Report") && wordCount && !isNaN(parseInt(wordCount))) {
                        outputSpecs += `Aim for a total word count of approximately ${parseInt(wordCount)} words.\n`;
                    }
                }
                // Add Detail Level instruction
                if (detailLevel === "Brief Overview") {
                    outputSpecs += "Keep the response concise and provide a high-level summary or the most critical points only.\n";
                } else if (detailLevel === "Comprehensive Explanation") {
                    outputSpecs += "Provide an in-depth and thorough explanation. Include supporting details, examples, and elaborate on key concepts where applicable.\n";
                } // Standard Detail (default) adds no extra line here.

                if (tone) {
                    outputSpecs += `The tone of the response should be consistently ${tone}.\n`;
                }
                outputSpecs += "Ensure your answer is well-structured, comprehensive, detailed, and easy to understand.\n";
                promptSegments.push(outputSpecs);


                let processInstructionsString = "### PROCESS & QUALITY ASSURANCE ###\n";
                let specificProcessContent = ""; 
                if (encourageStepByStepCheckbox.checked) { 
                    specificProcessContent += "Before generating the final response, engage in step-by-step thinking (chain-of-thought). If helpful, briefly outline your plan or reasoning process internally. Only output the final, polished response unless the plan itself is part of the requested output format.\n";
                }
                if (requestSelfCorrectionCheckbox.checked) { 
                    specificProcessContent += "Critically evaluate your own response for accuracy, completeness, clarity, and adherence to all instructions before finalizing it. Correct any identified issues.\n";
                }
                processInstructionsString += specificProcessContent;
                processInstructionsString += "Provide the output directly. Do not include any preliminary conversational remarks, self-correction statements, or apologies in the final output, unless such elements are explicitly part of the requested 'step-by-step thinking' display or the persona.\n";
                promptSegments.push(processInstructionsString);
            }

            const finalPrompt = promptSegments.join("\n\n");
            livePromptPreviewArea.textContent = finalPrompt.trim() ? finalPrompt.trim() : "Prompt will appear here as you fill the steps...";
            copyPromptButton.disabled = !finalPrompt.trim();
            // console.log("--- updateLivePreview finished ---"); 
        }

        function goToStep(stepNumber) {
            stepsElements[currentStepIndex].classList.add('hidden');
            stepsElements[currentStepIndex].classList.remove('active');
            currentStepIndex = stepNumber - 1;
            stepsElements[currentStepIndex].classList.remove('hidden');
            stepsElements[currentStepIndex].classList.add('active');
            updateLivePreview(); 
        }

        function finalizePrompt() {
            updateLivePreview();
            copyFeedback.textContent = "Prompt finalized and ready to copy!";
            livePromptPreviewArea.focus();
            livePromptPreviewArea.scrollTop = 0;
            setTimeout(() => { copyFeedback.textContent = ""; }, 3000);
        }

        taskDefinitionInput.addEventListener('input', updateLivePreview);
        aiPersonaInput.addEventListener('input', updateLivePreview);
        keyContextInput.addEventListener('input', updateLivePreview);
        wordCountInput.addEventListener('input', updateLivePreview);
        contextUrlInput.addEventListener('input', updateLivePreview); 

        function styleRadioLabels(radioGroupName) {
            const radios = document.querySelectorAll(`input[name="${radioGroupName}"]`);
            radios.forEach(radio => {
                const label = radio.closest('label');
                if (label) {
                    if (radio.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                }
            });
        }
        
        document.querySelectorAll('input[name="outputFormat"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const selectedValue = radio.value;
                if (selectedValue === "Paragraph(s)" || selectedValue === "Lengthy Comprehensive Report") {
                    wordCountContainer.classList.remove('hidden');
                } else {
                    wordCountContainer.classList.add('hidden');
                    wordCountInput.value = '';
                }
                updateLivePreview();
                styleRadioLabels('outputFormat');
            });
        });

        // Listener for new Detail Level radios
        document.querySelectorAll('input[name="detailLevel"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updateLivePreview();
                styleRadioLabels('detailLevel');
            });
        });

        toneRadios.forEach(radio => radio.addEventListener('change', () => {
            updateLivePreview();
            styleRadioLabels('tone');
        }));

        audienceInput.addEventListener('input', updateLivePreview);
        mandatoryInclusionsInput.addEventListener('input', updateLivePreview);
        constraintsAvoidInput.addEventListener('input', updateLivePreview);
        encourageStepByStepCheckbox.addEventListener('change', updateLivePreview);
        requestSelfCorrectionCheckbox.addEventListener('change', updateLivePreview);

        generateNowButton.addEventListener('click', finalizePrompt);

        copyPromptButton.addEventListener('click', () => {
            const promptText = livePromptPreviewArea.textContent;
            if (!promptText || promptText === "Prompt will appear here as you fill the steps...") {
                copyFeedback.textContent = "Nothing to copy!";
                setTimeout(() => { copyFeedback.textContent = ""; }, 2000);
                return;
            }
            navigator.clipboard.writeText(promptText)
                .then(() => {
                    copyFeedback.textContent = "Copied!";
                    setTimeout(() => { copyFeedback.textContent = ""; }, 2000);
                })
                .catch(err => {
                    copyFeedback.textContent = "Failed to copy.";
                    console.error('Failed to copy text: ', err);
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = promptText;
                        document.body.appendChild(textArea);
                        textArea.focus(); textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        copyFeedback.textContent = "Copied (fallback)!";
                    } catch (e) { console.error('Fallback copy failed: ', e); }
                    setTimeout(() => { copyFeedback.textContent = ""; }, 2000);
                });
        });

        resetButton.addEventListener('click', () => {
            taskDefinitionInput.value = '';
            aiPersonaInput.value = '';
            keyContextInput.value = '';
            const firstOutputFormatRadio = document.querySelector('input[name="outputFormat"]');
            if(firstOutputFormatRadio) firstOutputFormatRadio.checked = true;
            styleRadioLabels('outputFormat');
            wordCountContainer.classList.add('hidden'); 
            wordCountInput.value = ''; 
            contextUrlInput.value = ''; 
            
            // Reset Detail Level
            const standardDetailRadio = document.querySelector('input[name="detailLevel"][value="Standard Detail"]');
            if(standardDetailRadio) standardDetailRadio.checked = true;
            styleRadioLabels('detailLevel');
            
            const friendlyTone = document.querySelector('input[name="tone"][value="Friendly"]');
            if (friendlyTone) {
                friendlyTone.checked = true;
            } else {
                const firstToneRadio = document.querySelector('input[name="tone"]');
                if(firstToneRadio) firstToneRadio.checked = true;
            }
            styleRadioLabels('tone');

            audienceInput.value = '';
            mandatoryInclusionsInput.value = '';
            constraintsAvoidInput.value = '';
            encourageStepByStepCheckbox.checked = false;
            requestSelfCorrectionCheckbox.checked = false;

            goToStep(1);
            copyPromptButton.disabled = true;
            generateNowButton.disabled = true;
            copyFeedback.textContent = "";
        });

        stepsElements.forEach((step, index) => {
            if (index === 0) {
                step.classList.add('active');
                step.classList.remove('hidden');
            } else {
                step.classList.add('hidden');
                step.classList.remove('active');
            }
        });
        styleRadioLabels('outputFormat');
        styleRadioLabels('tone');
        styleRadioLabels('detailLevel'); // Initial style for detail level

        const initialOutputFormat = document.querySelector('input[name="outputFormat"]:checked').value;
        if (initialOutputFormat === "Paragraph(s)" || initialOutputFormat === "Lengthy Comprehensive Report") {
            wordCountContainer.classList.remove('hidden');
        } else {
            wordCountContainer.classList.add('hidden');
        }
        updateLivePreview(); // Initial call
    </script>
    <footer>
        <a href="hub.html">Back to Hub</a>
    </footer>
</body>
</html>
